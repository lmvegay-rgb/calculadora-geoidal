<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predecir Ondulación Geoidal | ESPE</title>
    <style>
        /* Fondo verde muy bajito como pediste */
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 0; 
            padding: 40px 20px;
            background-color: #f4f9f4; 
            color: #2c3e50; 
            line-height: 1.6;
        }

        .header-espe {
            text-align: center;
            margin-bottom: 40px;
        }

        .header-espe img {
            width: 320px; 
            height: auto;
            margin-bottom: 20px;
        }

        .titulo-principal {
            color: #1a4a1a; 
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 800;
        }

        .subtitulo-proyecto {
            color: #445a44;
            max-width: 800px;
            margin: 0 auto;
            font-size: 16px;
            font-weight: 400;
        }

        .contenedor { 
            background: #ffffff; 
            padding: 35px; 
            border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            margin: 0 auto 30px auto;
            max-width: 650px;
            border: 1px solid #e0e6e0;
        }

        .contenedor-verde {
            border-top: 6px solid #1a4a1a;
        }

        .contenedor-azul {
            border-top: 6px solid #2980b9;
        }

        h3 { 
            color: #1a4a1a; 
            margin-top: 0; 
            font-size: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        label { font-weight: 600; display: block; margin-top: 15px; color: #34495e; }
        
        input, select { 
            width: 100%; padding: 14px; margin-top: 8px; 
            box-sizing: border-box; border: 1px solid #dcdcdc; 
            border-radius: 8px; font-size: 15px; 
            background-color: #fafafa;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #1a4a1a;
            background-color: #fff;
        }

        button { 
            width: 100%; padding: 15px; border: none; 
            border-radius: 8px; font-size: 16px; font-weight: bold; 
            cursor: pointer; transition: all 0.3s ease;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-verde { background-color: #1a4a1a; color: white; }
        .btn-verde:hover { background-color: #2d6a2d; box-shadow: 0 4px 12px rgba(26,74,26,0.2); }

        .btn-azul { background-color: #2980b9; color: white; }
        .btn-azul:hover { background-color: #3498db; box-shadow: 0 4px 12px rgba(41,128,185,0.2); }

        .resultado { 
            margin-top: 25px; padding: 20px; 
            background-color: #f0fdf4; border: 1px solid #c6f6d5; 
            border-radius: 10px; font-weight: bold; 
            text-align: center; display: none; 
        }

        .resultado-texto { font-size: 16px; color: #2f855a; margin-bottom: 5px; }
        .resultado-valor { font-size: 28px; color: #1a4a1a; display: block; }

        footer {
            text-align: center;
            font-size: 13px;
            color: #888;
            margin-top: 50px;
            padding-bottom: 30px;
        }
    </style>
</head>
<body>

    <div class="header-espe">
        <img src="https://www.espe.edu.ec/wp-content/uploads/2018/12/logo-espe.png" alt="Universidad de las Fuerzas Armadas ESPE">
        <h1 class="titulo-principal">Predecir Ondulación Geoidal</h1>
        <p class="subtitulo-proyecto">
            Generación de un modelo de ondulación geoidal para la ciudad de Cuenca utilizando técnicas determinísticas y geoestadísticas
        </p>
    </div>

    <div class="contenedor contenedor-verde">
        <h3>Configuración del Análisis</h3>
        <label>Algoritmo de Interpolación:</label>
        <select id="modelo">
            <option value="1">Kriging Ordinario</option>
            <option value="2">Colocación Mínimos Cuadrados (MCC)</option>
            <option value="3">Mínima Curvatura (TPS)</option>
        </select>
    </div>

    <div class="contenedor contenedor-verde">
        <h3>Selección de Punto de Interpolación</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label>Coordenada Este (X):</label>
                <input type="number" id="x" placeholder="Ej: 720000">
            </div>
            <div>
                <label>Coordenada Norte (Y):</label>
                <input type="number" id="y" placeholder="Ej: 9900000">
            </div>
        </div>
        <button class="btn-verde" onclick="calcularUnico()">Calcular Ondulación (N)</button>
        <div id="resultadoUnico" class="resultado"></div>
    </div>

    <div class="contenedor contenedor-azul">
        <h3>Procesamiento por Lote (.txt)</h3>
        <p style="font-size: 14px; color: #666; background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 3px solid #2980b9;">
            Cargue un archivo de texto con columnas de coordenadas <strong>X</strong> e <strong>Y</strong> separadas por espacios.
        </p>
        <input type="file" id="archivoTxt" accept=".txt">
        <button class="btn-azul" onclick="calcularLote()">Procesar Archivo y Descargar</button>
        <div id="resultadoLote" class="resultado"></div>
    </div>

    <footer>
        <strong>UNIVERSIDAD DE LAS FUERZAS ARMADAS ESPE</strong><br>
        Departamento de Ciencias de la Tierra y la Construcción<br>
        Ingeniería Geográfica y del Medio Ambiente
    </footer>

    <script>
        const URL_BASE = "https://calculadora-geoidal-ciudad-de-cuenca.onrender.com"; 

        const URL_API_GET = `${URL_BASE}/predecir`;
        const URL_API_POST = `${URL_BASE}/predecir_lote`;

        async function calcularUnico() {
            const x = document.getElementById("x").value;
            const y = document.getElementById("y").value;
            const modelo = document.getElementById("modelo").value;
            const divRes = document.getElementById("resultadoUnico");

            if(!x || !y) return alert("Por favor, complete ambas coordenadas.");
            divRes.style.display = "block"; 
            divRes.innerHTML = "<span style='color: #666;'>⏳ Procesando datos en el servidor...</span>";

            try {
                const respuesta = await fetch(`${URL_API_GET}?x=${x}&y=${y}&modelo=${modelo}`);
                const datos = await respuesta.json();
                if (typeof datos.Z_Ondulacion === "number") {
                    divRes.innerHTML = `
                        <div class="resultado-texto">Cálculo completado exitosamente:</div>
                        <strong class="resultado-valor">N = ${datos.Z_Ondulacion.toFixed(4)} m</strong>
                    `;
                } else {
                    divRes.innerHTML = `<span style="color: #c0392b;">${datos.Z_Ondulacion}</span>`;
                }
            } catch (error) {
                divRes.innerHTML = "<span style='color: #c0392b;'>Error: El servicio de predicción no está disponible.</span>";
            }
        }

        async function calcularLote() {
            const fileInput = document.getElementById('archivoTxt');
            const modelo = document.getElementById('modelo').value;
            const divRes = document.getElementById("resultadoLote");

            if (!fileInput.files.length) return alert("Seleccione un archivo .txt para continuar.");

            divRes.style.display = "block"; 
            divRes.innerHTML = "<span style='color: #2980b9;'>⏳ Ejecutando procesamiento masivo...</span>";

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.trim().split('\n');
                const puntos = [];

                for(let line of lines) {
                    if (line.trim() === "") continue;
                    const parts = line.trim().split(/[\s,]+/);
                    if(parts.length >= 2) {
                        const x = parseFloat(parts[0]);
                        const y = parseFloat(parts[1]);
                        if(!isNaN(x) && !isNaN(y)) {
                            puntos.push({x: x, y: y});
                        }
                    }
                }

                if(puntos.length === 0) return alert("El archivo no contiene datos válidos.");

                try {
                    const response = await fetch(`${URL_API_POST}?modelo=${modelo}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(puntos)
                    });
                    
                    const data = await response.json(); 

                    let outText = "X\tY\tZ_Ondulacion\n";
                    data.forEach(row => {
                       outText += `${row.x}\t${row.y}\t${row.z_ondulacion.toFixed(4)}\n`;
                    });

                    const blob = new Blob([outText], {type: 'text/plain'});
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Resultados_Calculadora_Geoidal.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    divRes.innerHTML = "<span style='color: #2980b9;'>✅ Archivo procesado y descargado.</span>";
                    
                } catch (error) {
                    divRes.innerHTML = "<span style='color: #c0392b;'>Error al procesar el archivo por lote.</span>";
                }
            };
            
            reader.readAsText(file);
        }
    </script>
</body>
</html>
